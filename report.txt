–û—Ç—á—ë—Ç –Ω–∞ 14.12.2024 –æ —Ñ–∞–π–ª–∞—Ö *.py:
–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤ - 42
–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ - 1578
–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–º–≤–æ–ª–æ–≤ - 58084




------------------------------------------------------------
main.py:

# –ò–º–ø–æ—Ä—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫
import asyncio
import signal
import time
import traceback
from data_operators.maps_operator import save_maps_to_file
from core.maps_list import maps

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏—è
from variables import event_manager

# –ó–∞–ø—É—Å–∫–∞–µ–º —Ä–µ–∞–∫—Ç–æ—Ä—ã
from network import call_reaction, text_reaction

# –ò–º–ø–æ—Ä—Ç –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
from core.time_converter import get_full_current_date
from a_library.log_error import log_error_to_file
from data_operators.BD_init import init_db

# –ò–º–ø–æ—Ä—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
from variables.bot import dp,bot
from mechanics.game_core import process_game

from core import maps_list_operator


async def main():
    asyncio.create_task(process_game())
    await bot.delete_webhook(drop_pending_updates=True)
    print("Leviathan launched successfully")
    await dp.start_polling(bot, skip_updates=True)


async def on_shutdown(dp):
    save_maps_to_file(maps, "maps.json")
    print("–ü—Ä–æ–≥—Ä–∞–º–º–∞ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è... –û–∂–∏–¥–∞—é –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –∑–∞–¥–∞—á.")
    await bot.close()


def setup_shutdown():
    signal.signal(signal.SIGINT, lambda sig, frame: on_shutdown(dp))  # –î–ª—è Ctrl+C
    signal.signal(signal.SIGTERM, lambda sig, frame: on_shutdown(dp))  # –î–ª—è —Å–∏–≥–Ω–∞–ª–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞


init_db()


# –ó–∞–ø—É—Å–∫ main –≤ —Ü–∏–∫–ª–µ while true
if __name__ == "__main__":
    setup_shutdown()
    log_error_to_file(f"\n\n\n\n\n{'-'*30}\n{' '*13}Start {get_full_current_date()}\n{'-'*30}")
    while True:
        try:
            asyncio.run(main())
        except Exception as error:
            print(f'$ Fatal Error {get_full_current_date()} : ', error)
            log_error_to_file(f'Fatal Error {get_full_current_date()} : '+ str(error) +"\n\n"+traceback.format_exc())




------------------------------------------------------------
progect_info_generator.py:
import os
from datetime import datetime


def generate_report(folder_path: str, file_extension: str, report_name: str, ignored_paths: list) -> None:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç—á—ë—Ç –æ —Ñ–∞–π–ª–∞—Ö —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º –≤ –ø–∞–ø–∫–µ –∏ –ø–æ–¥–ø–∞–ø–∫–∞—Ö.

    :param folder_path: –ü—É—Ç—å –∫ –∫–æ—Ä–Ω–µ–≤–æ–π –ø–∞–ø–∫–µ.
    :param file_extension: –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, ".py").
    :param report_name: –ò–º—è –∏—Ç–æ–≥–æ–≤–æ–≥–æ –æ—Ç—á—ë—Ç–∞ (txt-—Ñ–∞–π–ª).
    :param ignored_paths: –°–ø–∏—Å–æ–∫ –ø—É—Ç–µ–π –¥–ª—è –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏—è (—Ñ–∞–π–ª—ã –∏ –ø–∞–ø–∫–∏).
    """
    print('–ì–µ–Ω–µ—Ä–∏—Ä—É—é –æ—Ç—á—ë—Ç...')

    total_files = 0
    total_lines = 0
    total_chars = 0
    files_data = []

    # –ü–µ—Ä–µ–±–æ—Ä —Ñ–∞–π–ª–æ–≤ –∏ –ø–æ–¥—Å—á—ë—Ç —Å—Ç—Ä–æ–∫ –∏ —Å–∏–º–≤–æ–ª–æ–≤
    for root, _, files in os.walk(folder_path):
        # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ø–∞–ø–∫–∏ –∏ —Ñ–∞–π–ª—ã, —É–∫–∞–∑–∞–Ω–Ω—ã–µ –≤ ignored_paths
        if any(ignored_path in root for ignored_path in ignored_paths):
            continue

        for file in files:
            if file.endswith(file_extension):
                # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –ø–æ –∏–º–µ–Ω–∏
                file_path = os.path.join(root, file)
                if any(ignored_path in file_path for ignored_path in ignored_paths):
                    continue

                total_files += 1
                with open(file_path, 'r', encoding='utf-8', errors='ignore') as f:
                    content = f.readlines()
                    line_count = len(content)
                    char_count = sum(len(line) for line in content)
                    total_lines += line_count
                    total_chars += char_count
                    relative_path = os.path.relpath(file_path, folder_path)
                    files_data.append((relative_path, ''.join(content)))

    # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –æ—Ç—á—ë—Ç–∞
    date = datetime.now().strftime("%d.%m.%Y")
    report_header = (
        f"–û—Ç—á—ë—Ç –Ω–∞ {date} –æ —Ñ–∞–π–ª–∞—Ö *{file_extension}:\n"
        f"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤ - {total_files}\n"
        f"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ - {total_lines}\n"
        f"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–º–≤–æ–ª–æ–≤ - {total_chars}\n\n"
    )

    # –ó–∞–ø–∏—Å—å –≤ –∏—Ç–æ–≥–æ–≤—ã–π —Ñ–∞–π–ª
    with open(report_name, 'w', encoding='utf-8') as report_file:
        report_file.write(report_header)
        for file_path, content in files_data:
            report_file.write(f"\n\n\n------------------------------------------------------------\n{file_path}:\n")
            report_file.write(content + "\n")

    print(f"–û—Ç—á—ë—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ —Ñ–∞–π–ª: {report_name}")


if __name__ == "__main__":
    folder = os.path.dirname(os.path.abspath(__file__))  # –ü—É—Ç—å –∫ —Ç–µ–∫—É—â–µ–π –ø–∞–ø–∫–µ
    extension = ".py"  # –ò—Å–∫–æ–º–æ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤
    report_file = "report.txt"  # –ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –æ—Ç—á—ë—Ç–∞
    ignored_paths = ['run', 'venv']  # –°–ø–∏—Å–æ–∫ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤ –∏ –ø–∞–ø–æ–∫

    generate_report(folder, extension, report_file, ignored_paths)




------------------------------------------------------------
project_path.py:
from os import path


def get_project_path() -> str:
    return path.dirname(path.abspath(__file__))

def get_global_path(local_path):
    return path.join(get_project_path(), local_path)




------------------------------------------------------------
a_library\custom_translator.py:
def Str_in_List2(Str):
    List = []
    Str_ = ''
    for i in Str:
        if i == ','and i != '[' and i != ']':
            try:
                List += [int(Str_)]
            except:
                List += [Str_]
            Str_ = ''
        elif i == ']':
            try:
                List += [int(Str_)]
            except:
                List += [Str_]
            Str_ = ''
        elif i != '[':
            Str_ += i

    return List
def Str_in_List(Str):
    if Str != '':
        List = []
        Str_ = ''
        for i in Str:
            if i == '-' :
                try:
                    List += [int(Str_)]
                except:

                    if Str_[0] == '[' and Str_[-1] == ']':
                        List += [Str_in_List2(Str_)]
                    else:
                        List += [Str_]
                Str_ = ''
            else:
                Str_ += i
        return List
    else:
        return []


def List_in_Str(List):
    Str = ''
    buf_List_in_Str_1 = len(List)
    for i in range(buf_List_in_Str_1):
        Str += str(List[i])
        Str += "-"
    return Str



------------------------------------------------------------
a_library\log_error.py:
# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø–∏—Å–∏ –æ—à–∏–±–æ–∫ –≤ —Ñ–∞–π–ª
def log_error_to_file(message):
    with open("error_log.txt", "a") as file:
        file.write(message + "\n\n\n\n\n")




------------------------------------------------------------
core\action.py:
from enum import Enum


class ActionType(Enum):
    move = 0,
    attack = 1,
    dive = 2


class Action:
    def __init__(self, object_, action_type, value):
        self.object_ = object_
        self.action_type = action_type
        self.value = value




------------------------------------------------------------
core\images_operator.py:
from os import path

import cv2
from aiogram import types
from project_path import get_global_path

cached_cv2_images = dict() # key - –ø—É—Ç—å, value - –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ


def get_cv2_image_from_path(path_):
    if path_ in cached_cv2_images:
        return cached_cv2_images[path_]
    else:
        cached_cv2_images[path_] = cv2.imread(path_, cv2.IMREAD_UNCHANGED)  # –ß—Ç–µ–Ω–∏–µ —Å –∞–ª—å—Ñ–∞-–∫–∞–Ω–∞–ª–æ–º
        return get_cv2_image_from_path(path_)

def get_image_path_from_ship_name(ship_name):
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ—Ä–Ω–µ–≤—É—é –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞ (—Ç–∞–º, –≥–¥–µ –ª–µ–∂–∏—Ç –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª –ø—Ä–æ–µ–∫—Ç–∞)
    return get_global_path(path.join('sprites', 'ships', f'{ship_name}.png'))

def get_ship_image_from_name(ship_name):
    image_path = get_image_path_from_ship_name(ship_name)
    return get_cv2_image_from_path(image_path)




------------------------------------------------------------
core\maps_list.py:
maps = {}




------------------------------------------------------------
core\maps_list_operator.py:
from models.map import Map
from data_operators.maps_operator import load_maps_from_file
from core.maps_list import maps


try:
    maps.update(load_maps_from_file("maps.json"))
except Exception as exception:
    maps.update({0 : Map()})
    print(f'–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç –∏–∑ maps.json: {exception}')

if len(maps) == 0:
    maps[0] = Map()




------------------------------------------------------------
core\map_generator.py:





------------------------------------------------------------
core\time_converter.py:
from datetime import datetime


def get_full_current_date() -> str:
    # –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏
    current_datetime = datetime.now()
    # –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ —Å—Ç—Ä–æ–∫—É
    return current_datetime.strftime("%Y-%m-%d %H:%M:%S")

# –ü–µ—Ä–µ–≤–æ–¥–∏—Ç —Å–µ–∫—É–Ω–¥—ã –≤ string –æ—Ç–æ–±—Ä–∞–∂–∞—é—â–∏–π –≤—Ä–µ–º—è
def seconds_to_time_string(time_seconds, show_only_parts = 999) -> str:
    if show_only_parts < 1:
        print("–û—à–∏–±–∫–∞ –≤ seconds_to_time_string(): show_only_parts –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–Ω–µ–µ 1")
        return ""

    days, not_days = divmod(time_seconds, 86400)
    hours, not_hours = divmod(not_days, 3600)
    minutes, not_minutes = divmod(not_hours, 60)
    seconds = not_minutes

    time_string = ""
    showed_parts = 0
    if days > 0:
        time_string += f"{int(days)}–¥ "
        showed_parts += 1
        if showed_parts >= show_only_parts:
            return time_string
    if hours > 0:
        time_string += f"{int(hours)}—á "
        showed_parts += 1
        if showed_parts >= show_only_parts:
            return time_string
    if minutes > 0:
        time_string += f"{int(minutes)}–º "
        showed_parts += 1
        if showed_parts >= show_only_parts:
            return time_string
    if seconds > 0 or time_string == "":
        time_string += f"{int(seconds)}—Å"
    return time_string





------------------------------------------------------------
core\users_list.py:
from models.user import users_id,users_dict




------------------------------------------------------------
core\vector2.py:

class Vector2:
    def __init__(self, x, y):
        self.x = x
        self.y = y

    def add(self, delta_pos):
        """–ü—Ä–∏–±–∞–≤–ª—è–µ—Ç –∫ —ç—Ç–æ–º—É –≤–µ–∫—Ç–æ—Ä—É –¥—Ä—É–≥–æ–π"""
        self.x += delta_pos.x
        self.y += delta_pos.y

    def summ(self, delta_pos):
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—É–º–º—É –≤–µ–∫—Ç–æ—Ä–æ–≤"""
        return Vector2(self.x + delta_pos.x, self.y + delta_pos.y)

    def to_str(self):
        return f'Vector2({self.x}, {self.y})'

    def equals(self, compare_to) -> bool:
        if self.x == compare_to.x and self.y == compare_to.y:
            return True
        else:
            return False




------------------------------------------------------------
core\call_reactions\arrows_reaction.py:
from aiogram import types
from core.maps_list import maps
from core.action import Action,ActionType
from core.users_list import users_dict


async def arrows_reaction(message: types.CallbackQuery):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å—Ç—Ä–µ–ª–æ–∫ –ø–µ—Ä–µ–¥–≤–∏–∂–µ–Ω–∏—è
    """

    if message.data == "‚Üë":
        # –í–µ—Ä—Ö
        maps[0].add_new_delayed_action(Action(users_dict[message.message.chat.id].controlled_ship, ActionType.move, 0))

    elif message.data == "‚Üê":
        # –í–ª–µ–≤–æ
        maps[0].add_new_delayed_action(Action(users_dict[message.message.chat.id].controlled_ship, ActionType.move, 90))

    elif message.data == "‚Üí":
        # –í–ø—Ä–∞–≤–æ
        maps[0].add_new_delayed_action(Action(users_dict[message.message.chat.id].controlled_ship, ActionType.move, -90))

    elif message.data == "‚Üì":
        # –í–Ω–∏–∑
        maps[0].add_new_delayed_action(Action(users_dict[message.message.chat.id].controlled_ship, ActionType.move, 180))

    elif message.data == "‚¨à":
        # –ü—Ä–∞–≤—ã–π –≤–µ—Ä—Ö–Ω–∏–π —É–≥–æ–ª
        maps[0].add_new_delayed_action(Action(users_dict[message.message.chat.id].controlled_ship, ActionType.move, -45))


    elif message.data == "‚¨â":
        # –õ–µ–≤—ã–π –≤–µ—Ä—Ö–Ω–∏–π —É–≥–æ–ª
        maps[0].add_new_delayed_action(Action(users_dict[message.message.chat.id].controlled_ship, ActionType.move, 45))


    elif message.data == "‚¨ã":
        # –õ–µ–≤—ã–π –Ω–∏–∂–Ω–∏–π —É–≥–æ–ª
        maps[0].add_new_delayed_action(Action(users_dict[message.message.chat.id].controlled_ship, ActionType.move, 135))


    elif message.data == "‚¨ä":
        # –ü—Ä–∞–≤—ã–π –Ω–∏–∂–Ω–∏–π —É–≥–æ–ª
        maps[0].add_new_delayed_action(Action(users_dict[message.message.chat.id].controlled_ship, ActionType.move, -135))




------------------------------------------------------------
core\call_reactions\cancel_reaction.py:
import asyncio

from aiogram import types

from core.maps_list import maps
from core.users_list import users_dict
from UI import map_visualizer


async def cancel_reaction(message: types.CallbackQuery):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –æ—Ç–º–µ–Ω—ã —Ö–æ–¥–∞"""
    if message.data == "cancel":
        if message.message.chat.id in users_dict and users_dict[message.message.chat.id].current_map is not None and users_dict[message.message.chat.id].controlled_ship is not None:
            maps[users_dict[message.message.chat.id].current_map].cancel_object_delayed_actions(users_dict[message.message.chat.id].controlled_ship)
            asyncio.create_task(map_visualizer.update_map_message_of_user(users_dict[message.message.chat.id], True))




------------------------------------------------------------
core\text_reactions\map_reaction.py:
import asyncio
from random import randint

from aiogram import types
from UI.inline_keyboard_buttons import ship_control_buttons
from UI.map_visualizer import update_map_message_of_user
from network import async_messages_operator
from core.vector2 import Vector2
from core.maps_list import maps
from models import user
from models.world_objects.ship import Ship
import random

async def map_button_reaction(message: types.Message):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤–æ–π –∫–Ω–æ–ø–∫–∏ –ö–∞—Ä—Ç–∞ üó∫
    """
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–º–∞–Ω–¥—É
    if message.text == "–ö–∞—Ä—Ç–∞ üó∫":
        # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user_ = user.users_dict[message.chat.id]

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –µ—Å—Ç—å –ª–∏ —É –∏–≥—Ä–æ–∫–∞ –∫–æ—Ä–∞–±–ª—å
        if user_.controlled_ship is None:
            player_ship = Ship(position=Vector2(randint(-2, 2), randint(-2, 2)), rotation=0, sprite_name=f'ship {randint(1, 5)}')
            player_ship.register_owner(user_)
            maps[user_.current_map].add_new_object(player_ship)
        else:
            for i in maps.keys():
                for object_ in maps[i].objects:
                    if type(object_) == Ship:
                        if object_.owner.id == user_.id:
                            user_.controlled_ship  =  object_
                            break


        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –∫–∞—Ä—Ç—É –µ—Å–ª–∏ –æ–Ω–∞ –±—ã–ª–∞ –∏ –æ—Ç—Å—ã–ª–∞–µ–º –Ω–æ–≤—É—é
        asyncio.create_task(async_messages_operator.try_delete_message(user_.id, user_.map_message_id))
        user_.map_message_id = None
        asyncio.create_task(update_map_message_of_user(user_))




------------------------------------------------------------
core\text_reactions\start_reaction.py:
import asyncio, os

from aiogram.enums import ParseMode

from variables.bot import bot
from models.user import User
from UI.keyboard_buttons import button_map

from aiogram import types
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton


async def command_start(message: types.Message):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start.
    """
    #print('t', message.text, message.text == "/start")

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–º–∞–Ω–¥–∞ "/start"
    if message.text == "/start":
        caption = '''–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–∏—Ä –•–∞—Ä–∏–±–¥—ã! üåä

–ú–∏—Ä –ø–æ–≥–ª–æ—â—ë–Ω –æ–∫–µ–∞–Ω–æ–º, –º–æ–Ω—Å—Ç—Ä—ã –¥–µ—Ä–∂–∞—Ç –æ—Å—Ç–∞—Ç–∫–∏ —á–µ–ª–æ–≤–µ—á–µ—Å—Ç–≤–∞ –≤ —Å—Ç—Ä–∞—Ö–µ, –∞ –≤—ã ‚Äì –∫–∞–ø–∏—Ç–∞–Ω –∫–æ—Ä–∞–±–ª—è, –∫–æ—Ç–æ—Ä—ã–π –¥–æ–ª–∂–µ–Ω –≤—ã–∂–∏—Ç—å –∏ –ø–æ–º–æ—á—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ü–∏–≤–∏–ª–∏–∑–∞—Ü–∏—é. üö¢

- –£–ø—Ä–∞–≤–ª—è–π—Ç–µ —Å–≤–æ–∏–º –∫–æ—Ä–∞–±–ª—ë–º.
- –ò—Å—Å–ª–µ–¥—É–π—Ç–µ –∑–∞—Ç–æ–Ω—É–≤—à–∏–µ –≥–æ—Ä–æ–¥–∞.
- –°—Ä–∞–∂–∞–π—Ç–µ—Å—å —Å –º–æ–Ω—Å—Ç—Ä–∞–º–∏ –∏ –ø–∏—Ä–∞—Ç–∞–º–∏.
- –ü–æ–º–Ω–∏—Ç–µ: –æ–¥–Ω–∞ –æ—à–∏–±–∫–∞ ‚Äì –∏ –≤—Å—ë –ø–æ—Ç–µ—Ä—è–Ω–æ.
‚öì –ù–∞–∂–º–∏ *–ö–∞—Ä—Ç–∞* üó∫, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Å–≤–æ—ë –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ:

–£–¥–∞—á–∏, –∫–∞–ø–∏—Ç–∞–Ω! –¢–æ–ª—å–∫–æ –≤—ã –º–æ–∂–µ—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Å—É–¥—å–±—É —á–µ–ª–æ–≤–µ—á–µ—Å—Ç–≤–∞. üåå'''

        photo = types.FSInputFile("sprites/intro_image.webp")

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ —Å —Ç–µ–∫—Å—Ç–æ–º –∏ –∫–Ω–æ–ø–∫–∞–º–∏
        await message.bot.send_photo(
                    chat_id=message.chat.id,
                    photo=photo,
                    caption=caption,
                    parse_mode=ParseMode.MARKDOWN,
                    reply_markup = button_map
                )





------------------------------------------------------------
data_operators\BD_init.py:
import sqlite3
import os
from a_library.custom_translator import List_in_Str, Str_in_List

# –ò–º—è —Ñ–∞–π–ª–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
DB_FILE = os.path.join(os.path.dirname(__file__), "local_database.db")

def init_db():
    try:
        # –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –ª–æ–∫–∞–ª—å–Ω–æ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö (—Ñ–∞–π–ª —Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç)
        with sqlite3.connect(DB_FILE) as conn:
            cursor = conn.cursor()
            # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
            cursor.execute("""
                CREATE TABLE IF NOT EXISTS example_table (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    name TEXT NOT NULL,
                    artefact TEXT,
                    special_info TEXT,
                    checking_ship INTEGER DEFAULT 0,
                    current_map INTEGER DEFAULT 0
                )
            """)
            print("–¢–∞–±–ª–∏—Ü–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!")
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {e}")

def add_user(user_id, name, artefact=None, special_info=None, current_map=None):
    artefact = artefact or []
    special_info = special_info or []
    try:
        with sqlite3.connect(DB_FILE) as conn:
            cursor = conn.cursor()
            # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            cursor.execute("""
                INSERT INTO example_table (id, name, artefact, special_info, current_map)
                VALUES (?, ?, ?, ?, ?)
            """, (user_id, name, List_in_Str(artefact), List_in_Str(special_info), current_map))
            print(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å '{name}' —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!")
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")

def get_user(user_id):
    try:
        with sqlite3.connect(DB_FILE) as conn:
            cursor = conn.cursor()
            user = cursor.execute("SELECT * FROM example_table WHERE id = ?", (user_id,)).fetchone()
            if user:
                user = list(user)
                user[2] = Str_in_List(user[2]) if user[2] else []
                user[3] = Str_in_List(user[3]) if user[3] else []
                return user, True
            return None, False
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")
        return None, False

def save_user(user_id, name=None, artefact=None, special_info=None, current_map=0, checking_ship=False):
    try:
        with sqlite3.connect(DB_FILE) as conn:
            cursor = conn.cursor()
            existing_user = cursor.execute("SELECT * FROM example_table WHERE id = ?", (user_id,)).fetchone()
            if not existing_user:
                print(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å ID {user_id} –Ω–µ –Ω–∞–π–¥–µ–Ω!")
                return False
            # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ –ø–æ–ª—è
            if name is not None:
                cursor.execute("UPDATE example_table SET name = ? WHERE id = ?", (name, user_id))
            if artefact is not None:
                cursor.execute("UPDATE example_table SET artefact = ? WHERE id = ?", (List_in_Str(artefact), user_id))
            if special_info is not None:
                cursor.execute("UPDATE example_table SET special_info = ? WHERE id = ?", (List_in_Str(special_info), user_id))
            cursor.execute("UPDATE example_table SET current_map = ?, checking_ship = ? WHERE id = ?",
                           (current_map, int(checking_ship), user_id))
            print(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å ID {user_id} —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!")
            return True
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")
        return False

def get_all_user_ids():
    try:
        with sqlite3.connect(DB_FILE) as conn:
            cursor = conn.cursor()
            user_ids = cursor.execute("SELECT id FROM example_table").fetchall()
            return [user_id[0] for user_id in user_ids]
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {e}")
        return []




------------------------------------------------------------
data_operators\maps_operator.py:
from data_operators import pickle_operator
from core.maps_list import maps

saved_maps_path = "data\maps.pkl"


def save_maps():
    success, exception = pickle_operator.try_save_data(maps, saved_maps_path)
    if success:
        print("–ö–∞—Ä—Ç—ã —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã")

def load_maps():
    success, exception = pickle_operator.try_load_data(saved_maps_path)
    if success:
        print("–ö–∞—Ä—Ç—ã —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã")




------------------------------------------------------------
data_operators\pickle_operator.py:
import pickle


def try_save_data(data, path):
    """
    :param data: –î–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    :param path: –ü—É—Ç—å
    :return: (—É—Å–ø–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–∏, –æ—Ç—á—ë—Ç –æ–± –æ—à–∏–±–∫–µ(–µ—Å–ª–∏ –µ—Å—Ç—å))
    """
    try:
        with open(path, 'wb') as file:
            pickle.dump(data, file)
            return True, None
    except Exception as exception:
        return False, exception


def try_load_data(path):
    """
    :param path: –ü—É—Ç—å —Ñ–∞–π–ª–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
    :return: (–∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–ª–∏ None –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏, –æ—Ç—á—ë—Ç –æ–± –æ—à–∏–±–∫–µ(–µ—Å–ª–∏ –µ—Å—Ç—å))
    """
    try:
        with open(path, 'rb') as file:
            return pickle.load(file), None
    except Exception as exception:
        return False, exception



------------------------------------------------------------
mechanics\game_core.py:
import asyncio
import time

#from signal import pthread_sigmask

from core.maps_list import maps
from core.vector2 import Vector2
from core.action import ActionType
from UI.map_visualizer import update_map_message_of_user

# –ò–º–ø–æ—Ä—Ç –æ–±—ä–µ–∫—Ç–æ–≤ –∫–∞—Ä—Ç—ã
from models.user import User
from models.world_objects.ship import Ship

from settings.global_settings import render_out_of_border_range

from data_operators.maps_operator import save_maps_to_file


game_active = True
short_step_delay = 1 # –ü–µ—Ä–∏–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±—ã—Å—Ç—Ä—ã—Ö —è–≤–ª–µ–Ω–∏–π(–ø–æ–ª—ë—Ç —Å–Ω–∞—Ä—è–¥–∞, —ç—Ñ—Ñ–µ–∫—Ç –≤–∑—Ä—ã–≤–∞ –∏ —Ç. –¥.)
step_delay = 5 # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è(–ø–µ—Ä–µ–¥–≤–∏–∂–µ–Ω–∏—è –∫–æ—Ä–∞–±–ª—è, —Å–æ–≤–µ—Ä—à–µ–Ω–∏–µ –ø–æ–≥—Ä—É–∂–µ–Ω–∏—è –∏ —Ç. –¥.); –î–û–õ–ñ–ï–ù –ë–´–¢–¨ –ö–†–ê–¢–ù–´–ú short_step_delay !!!





# –ó–∞–ø—É—Å–∫–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–≤–µ—Ä—à–µ–Ω–∏–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–µ —Å –∑–∞–¥–∞–Ω–Ω—ã–º –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º
async def process_game():
    if step_delay % short_step_delay != 0:
        raise Exception("$ –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å game_core.process_game, —Ç–∞–∫ –∫–∞–∫ step_delay –Ω–µ –∫—Ä–∞—Ç–µ–Ω short_step_delay, –∞ —ç—Ç–æ —É—Å–ª–æ–≤–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ")

    '''test_map = maps[0]
    test_user = User(5609117794)
    test_ship = Ship(owner=test_user, sprite_name=f"ship {2}", position=Vector2(2, 5), rotation=90, max_hp=100)
    test_ship2 = Ship(owner=None, sprite_name=f"ship {4}", position=Vector2(1, 2), rotation=180, max_hp=100)
    test_user.controlled_ship = test_ship
    test_user.current_map = test_map
    test_action = Action(object_=test_ship, action_type=ActionType.move, value=180)
    test_map.add_new_object(test_ship)
    test_map.add_new_object(test_ship2)
    test_map.add_new_delayed_action(test_action)'''

    short_step_num = 0
    short_steps_in_basic_step = int(step_delay / short_step_delay) # –†–∞–∑ –≤ —Å–∫–æ–ª—å–∫–æ –±—ã—Å—Ç—Ä—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –¥–µ–ª–∞—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    while game_active:
        await asyncio.sleep(short_step_delay)
        for map_ in maps.values():
            process_map_iteration(map_, True)
            short_step_num += 1
            if short_step_num >= short_steps_in_basic_step:
                process_map_iteration(map_, False)
                short_step_num = 0

            update_visual_map(map_)


# –°–æ–≤–µ—Ä—à–µ–Ω–∏–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
def process_map_iteration(map_, short_update):
    if not short_update:
        delayed_actions_list = map_.delayed_actions
    else:
        delayed_actions_list = map_.short_delayed_actions

    delayed_actions_to_remove = []
    for delayed_action in delayed_actions_list:
        object_ = delayed_action.object_
        action_type = delayed_action.action_type
        if action_type == ActionType.move:
            map_.add_changed_square(object_)
            if type(object_) == Ship:
                object_.move(delayed_action.value)

        # –î–æ–±–∞–≤–ª—è–µ–º –¥–µ–π—Å—Ç–≤–∏–µ –≤ —Å–ø–∏—Å–æ–∫ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ
        delayed_actions_to_remove.append(delayed_action)

        # –ü–æ–º–µ—á–∞–µ–º —Ç–∞–∫–∂–µ –∫–≤–∞–¥—Ä–∞—Ç –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º —Å—Ç–æ–∏—Ç –æ–±—ä–µ–∫—Ç —Å–µ–π—á–∞—Å –Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –æ–Ω —Å–¥–≤–∏–Ω—É–ª—Å—è
        map_.add_changed_square(object_)

    # –£–¥–∞–ª—è–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
    if short_update:
        for action_to_remove in delayed_actions_to_remove:
            map_.short_delayed_actions = [action for action in map_.short_delayed_actions if not action == action_to_remove]
    else:
        for action_to_remove in delayed_actions_to_remove:
            map_.delayed_actions = [action for action in map_.delayed_actions if not action == action_to_remove]


# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∏–∑—É–∞–ª—å–Ω—ã—Ö –∫–∞—Ä—Ç —É –∏–≥—Ä–æ–∫–æ–≤, –∫–æ—Ç–æ—Ä—ã–º —ç—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
def update_visual_map(map_):
    showed_changed_squares = dict() # –°—é–¥–∞ –¥–æ–±–∞–≤–ª—è–µ–º –∫–≤–∞–¥—Ä–∞—Ç—ã –Ω–∞ –∫–∞—Ä—Ç–µ, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –±—ã–ª–∏ "–ø–æ–≥–∞—à–µ–Ω—ã", —Ç–æ –µ—Å—Ç—å –∏–≥—Ä–æ–∫–∏ –∏—Ö —É–≤–∏–¥–µ–ª–∏
    users_to_update_map = dict()
    for object_ in map_.objects:
        if type(object_) == Ship and type(object_.owner) == User:
            min_view_limits = object_.position.summ(Vector2(-object_.view_range - render_out_of_border_range, -object_.view_range - render_out_of_border_range))
            max_view_limits = object_.position.summ(Vector2(object_.view_range + render_out_of_border_range, object_.view_range + render_out_of_border_range))

            for changed_square in map_.changed_squares:
                # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–µ–∂–∏—Ç –ª–∏ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–π –∫–≤–∞–¥—Ä–∞—Ç –≤ –æ–±–ª–∞—Å—Ç–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –∏–≥—Ä–æ–∫–∞
                if min_view_limits.x <= changed_square.x <= max_view_limits.x and min_view_limits.y <= changed_square.y <= max_view_limits.y:
                    showed_changed_squares[Vector2(changed_square.x, changed_square.y)] = True
                    users_to_update_map[object_.owner] = True

    # –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∫–∞—Ä—Ç—É
    if len(users_to_update_map.keys()) != 0:
        t = time.time()
        save_maps_to_file(maps, "maps.json")
        print(f"–í—Ä–µ–º—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–∞—Ä—Ç : {time.time()-t}")

    # –û—Ç—Å—ã–ª–∞–µ–º –∫–∞—Ä—Ç—ã –∑–∞–Ω–æ–≤–æ –∫–æ–º—É –Ω–∞–¥–æ
    for user in users_to_update_map.keys():
        asyncio.create_task(update_map_message_of_user(user))

    # –£–¥–∞–ª—è–µ–º "–ø–æ–≥–∞—à–µ–Ω–Ω—ã–µ" –∫–≤–∞–¥—Ä–∞—Ç—ã –∏–∑ —Å–ø–∏—Å–∫–∞
    for showed_changed_square in showed_changed_squares.keys():
        map_.changed_squares = [changed_square for changed_square in map_.changed_squares if not changed_square.equals(showed_changed_square)]




------------------------------------------------------------
models\async_event.py:

import asyncio

class AsyncEvent:
    def __init__(self):
        self._subscribers = []

    # –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏–µ (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –∫–∞–∫ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ, —Ç–∞–∫ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏)
    def subscribe(self, callback):
        self._subscribers.append(callback)

    # –í—ã–∑–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ
    def trigger(self, *args, **kwargs):
        for callback in self._subscribers:
            if asyncio.iscoroutinefunction(callback):
                asyncio.run(callback(*args, **kwargs))  # –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
            else:
                callback(*args, **kwargs)  # –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫




------------------------------------------------------------
models\event.py:
import asyncio

class Event:
    def __init__(self):
        self.handlers = []

    def add_handler(self, handler):
        self.handlers.append(handler)

    def trigger(self, *args, **kwargs):
        for handler in self.handlers:
            asyncio.create_task(handler(*args, **kwargs))



------------------------------------------------------------
models\map.py:
import asyncio
import copy
from asyncio import create_task

from UI import map_visualizer
from core.maps_list import maps
from models.user import User
from models.world_objects.ship import Ship
from network import async_messages_operator


class Map:
    def __init__(self):
        self.objects = []
        self.delayed_actions = [] # –î–µ–π—Å—Ç–≤–∏—è, –Ω–∞—Ö–æ–¥—è—â–∏–µ—Å—è –≤ —Å–ø–∏—Å–∫–µ –æ–∂–∏–¥–∞–Ω–∏—è (–ø–µ—Ä–µ–¥–≤–∏–∂–µ–Ω–∏–µ –∫–æ—Ä–∞–±–ª—è/—Å—É—â–µ—Å—Ç–≤–∞, –Ω—ã—Ä—è–Ω–∏–µ, –ø–æ—Å—Ç—Ä–æ–π–∫–∞ –∏ —Ç. –¥.)
        self.short_delayed_actions = []  # –ö–æ—Ä–æ—Ç–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è, –Ω–∞—Ö–æ–¥—è—â–∏–µ—Å—è –≤ —Å–ø–∏—Å–∫–µ –æ–∂–∏–¥–∞–Ω–∏—è (–ø–æ–ª—ë—Ç —Å–Ω–∞—Ä—è–¥–∞, –≤–∑—Ä—ã–≤ –∏ —Ç. –¥.)
        self.changed_squares = [] # –ö–≤–∞–¥—Ä–∞—Ç—ã, –Ω–∞ –∫–æ—Ç–æ—Ä—ã—Ö –≤ –±—ã–ª–∏ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è(–µ—Å–ª–∏ —Ç–∞–∫–æ–π –∫–≤–∞–¥—Ä–∞—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤ –ø–æ–ª–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ —É –∏–≥—Ä–æ–∫–∞, —Ç–æ —Å—Ç–æ–∏—Ç –ø–µ—Ä–µ–≤—ã—Å–ª–∞—Ç—å –µ–º—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã)

    def add_new_object(self, object_):
        self.objects.append(object_)
        self.add_changed_square(object_)

    def add_new_delayed_action(self, new_action, short_action = False, override = True):
        """
        –î–æ–±–∞–≤–ª—è–µ—Ç –æ–∂–∏–¥–∞–µ–º–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –≤ —Å–ø–∏—Å–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π –Ω–∞ –∫–∞—Ä—Ç–µ
        :param new_action: –°—é–¥–∞ –ø–æ–¥–∞–≤–∞—Ç—å —ç–∫–∑–µ–º–ø–ª—è—Ä –∫–ª–∞—Å—Å–∞ Action
        :param short_action: –ö–æ—Ä–æ—Ç–∫–æ–µ –ª–∏ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ
        :param override: –î–∞ = –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ —ç—Ç–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –¥—Ä—É–≥–æ–µ, –Ω–µ—Ç = –¥–æ–±–∞–≤–∏—Ç –µ—â—ë –æ–¥–Ω–æ –≤ –ª—é–±–æ–º
        """
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É –û—Ç–º–µ–Ω–∞
        if not short_action and type(new_action.object_) == Ship and type(new_action.object_.owner) == User:
            asyncio.create_task(map_visualizer.update_map_message_of_user(new_action.object_.owner, True))
            pass


        if not short_action:
            actions_list = self.delayed_actions
        else:
            actions_list = self.short_delayed_actions

        if override:
            actions_list = [action for action in actions_list if action.object_ != new_action.object_]
        actions_list.append(new_action)

        if not short_action:
            self.delayed_actions = actions_list
        else:
            self.short_delayed_actions = actions_list

    def check_if_object_has_delayed_actions(self, object_, short_actions = False):
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –µ—Å—Ç—å –ª–∏ —É –æ–±—ä–µ–∫—Ç–∞ –æ–∂–∏–¥–∞–µ–º—ã–µ –¥–µ–π—Å—Ç–≤–∏—è. –ü–æ–ª–µ–∑–Ω–æ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –µ—Å—Ç—å –ª–∏ —É–∂–µ —É –∫–æ—Ä–∞–±–ª—è –¥–µ–π—Å—Ç–≤–∏—è –≤ —Å–ø–∏—Å–∫–µ –æ–∂–∏–¥–∞–Ω–∏–π, —á—Ç–æ–±—ã –æ–Ω –Ω–µ –º–æ–≥ —Å–æ–≤–µ—Ä—à–∏—Ç—å –±–æ–ª–µ–µ 1 –¥–µ–π—Å—Ç–≤–∏—è –∑–∞ —Ö–æ–¥"""
        if not short_actions:
            delayed_actions_list = self.delayed_actions
        else:
            delayed_actions_list = self.short_delayed_actions

        for delayed_action in delayed_actions_list:
            if delayed_action.object_ == object_:
                return True
        return False

    def cancel_object_delayed_actions(self, object_):
        """–£–¥–∞–ª—è–µ—Ç –≤—Å–µ –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –æ–±—ä–µ–∫—Ç–∞ (–∫—Ä–æ–º–µ short actions, –∏—Ö –æ—Ç–º–µ–Ω–∏—Ç—å –Ω–µ–ª—å–∑—è)"""
        self.delayed_actions = [action for action in self.delayed_actions if action.object_ != object_]

    def add_changed_square(self, object_):
        self.changed_squares.append(copy.deepcopy(object_.position))




------------------------------------------------------------
models\skill.py:
from enum import Enum

skill = {
"leg" :[
    '–ë–æ–≥ –º–æ—Ä–µ–π',  # –ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π –±–æ–Ω—É—Å –∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é –∫–æ—Ä–∞–±–ª—ë–º
    '–ë–µ—Å—Å–º–µ—Ä—Ç–Ω—ã–π',  # –û–±–ª–∞–¥–∞—Ç–µ–ª—å–Ω–∞–≤—ã–∫–∞ –Ω–µ –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –º–µ–Ω—å—à–µ 1 —Ö–ø
    '–ü—Ä–æ–≤–æ–¥–Ω–∏–∫ –¥—É—à'# –ü–æ–ª—É—á–∞–µ—Ç +1 –±–æ–Ω—É—Å–Ω–æ–µ –æ—á–∫–æ –∑–∞ –∫–∞–∂–¥–æ–≥–æ –ø–æ–≥–∏–±—à–µ–≥–æ —á–ª–µ–Ω–∞ —ç–∫–∏–ø–∞–∂–∞ —Å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é (100 - n*10)% –≥–¥–µ n - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–æ–Ω—É—Å–æ–≤ –ø–æ–ª—É—á–µ–Ω—ã—Ö —Ç–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º
],
"rare" :[
    '–ö–∏—Ç–æ–±–æ–π',  # –±–æ–Ω—É—Å –∫ —É—Ä–æ–Ω—É –ø–æ –º–æ–Ω—Å—Ç—Ä–∞–º
    '–ú–µ—Ä—Ç–≤–µ—Ü',  # —É–º–µ–Ω—å—à–∞–µ–º —Å—Ç–∞–º–∏–Ω—É —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∂–∏–≤—É—á–µ—Å—Ç—å
    '–ñ—Ä–µ—Ü',  # –ú–æ–∂–µ—Ç –≤–æ—Å—Ç–æ–Ω–∞–≤–∏—Ç—å 1 –•–ü —Å–∞–º–æ–º—É —Ä–∞–Ω–µ–Ω–æ–º—É —á–ª–µ–Ω—É —ç–∫–∏–ø–∞–∂–∞ –µ—Å–ª–∏ –ø–æ–≥–∏–± —á–ª–æ–Ω —ç–∫–∏–ø–∞–∂–∞
    '–í–µ–∑—É–Ω—á–∏–∫',  # –ü—Ä–∏ HP = 0 c 50% –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é –≤–æ—Å—Ç–æ–Ω–∞–≤–ª–∏–≤–∞–µ—Ç 1 —Ö–ø
    '–ú–µ–¥–∏–∫',  # –ú–æ–∂–µ—Ç —Å 5% –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é –≤–æ—Å—Ç–æ–Ω–∞–≤–∏—Ç—å 1 —Ö–ø —Å–∞–º–æ–º—É —Ä–∞–Ω–µ–Ω–æ–º—É —á–ª–µ–Ω—É —ç–∫–∏–ø–∞–∂–∞
    '–ü–ª–æ—Ç–Ω–∏–∫ 2'  # –ú–æ–∂–µ—Ç —Å 10% –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é –≤–æ—Å—Ç–æ–Ω–∞–≤–∏—Ç—å 1 —Ö–ø –∫–æ—Ä–∞–±–ª—é
],
"simple" : [
    '–ü–ª–æ—Ç–Ω–∏–∫',  # –ú–æ–∂–µ—Ç —Å 5% –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é –≤–æ—Å—Ç–æ–Ω–∞–≤–∏—Ç—å 1 —Ö–ø –∫–æ—Ä–∞–±–ª—é
    '–û—Ö–æ—Ç–Ω–∏–∫ –∑–∞ –≥–æ–ª–æ–≤–∞–º–∏',  # –ü—Ä–∏ –æ–±–æ—Ä–¥–∞–∂–µ –∏–º–µ–µ—Ç –±–æ–Ω—É—Å –∫ –∞—Ç–∞–∫–µ 2
    '–°—Ç—Ä–µ–ª–æ–∫',  # –ø—Ä–∏ –∞—Ç–∞–∫–µ –Ω–∞ –º–æ–Ω—Å—Ç—Ä–æ–≤ –∏–º–µ–µ—Ç –æ–ø—ã—Ç –≤ –∞—Ç–∞–∫–µ 2
    '–ë–æ–µ—Ü',  # –ë–æ–Ω—É—Å –∫ –∞—Ç–∞–∫–µ 1
    '–û—Ö–æ—Ç–Ω–∏–∫'  # –ü—Ä–∏ –∞—Ç–∞–∫–µ –º–æ–Ω—Å—Ç—Ä–æ–º –∏–ª–∏ –∑–∞—â–∏—Ç–µ –æ—Ç –Ω–µ–≥–æ +2 –∫ –£–ø—Ä–∞–≤–ª–µ–Ω–∏—é  –∏  +2 –∫ –∞—Ç–∞–∫–µ
]}




------------------------------------------------------------
models\user.py:
from data_operators.BD_init import add_user, get_user, save_user

from data_operators.BD_init import get_all_user_ids


# –ö–ª–∞—Å—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Ö—Ä–∞–Ω—è—â–∏–π –µ–≥–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –∏ —Ç. –¥.
class User:
    def __init__(self, user_id):
        global users_dict
        #–¢—É—Ç —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ
        self.id = user_id
        self.name = ' ___ '
        self.artefacts = []
        self.special_info = []
        self.current_map = 0
        self.map_message_id = None

        self.controlled_ship = None;  """–ó–∞–¥–∞–≤–∞—Ç—å —Å –ø–æ–º–æ—â—å—é ship.register_owner(owner)"""


        #–ø–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∏–≥—Ä–æ–∫–µ —Å —Ç–∞–∫–∏–º ID –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        user, examination = get_user(user_id)

        
        if examination:
            self.name, self.artefacts, self.special_info, self.controlled_ship, self.current_map  = user[1:]

            if self.current_map is None:
                self.current_map = 0
        else:
            self.__new_user()
            #self.controlled_ship = Ship(self,Vector2(0,0),0, "ship 1",100, 4)
            #maps[0].add_new_object(self.controlled_ship)
            #print(maps[0].objects)
            #maps[0].add_new_object(Ship(self, Vector2(2, 2), 0, "ship 3", 100, 4))
        users_dict[user_id] = self




    def __new_user(self, name = "No name", artefacts=None, special_info = None):
        add_user(self.id,name)

    def save_user(self):
        save_user(self.id, self.name, self.artefacts, self.special_info, self.current_map, checking_ship =
                    self.controlled_ship is None)


users_id  = get_all_user_ids()
users_dict = {}

for i in users_id:
    User(i)



------------------------------------------------------------
models\world_objects\Character.py:
import random
from models.skill import skill


# –ß–∞—Å—Ç–∏ –∏–º–µ–Ω–∏
nicknames = [
    "–ß–µ—Ä–Ω—ã–π", "–ö—Ä–∞—Å–Ω—ã–π", "–ó–æ–ª–æ—Ç–æ–π", "–°–µ—Ä–µ–±—Ä—è–Ω—ã–π", "–ë–µ—à–µ–Ω—ã–π",
    "–ö—Ä–æ–≤–∞–≤—ã–π", "–ñ–µ–ª–µ–∑–Ω—ã–π", "–®—Ç–æ—Ä–º–æ–≤–æ–π", "–¢–µ–Ω–µ–≤–æ–π", "–î–∏–∫–∏–π",
    "–ì—Ä–æ–∑–Ω—ã–π", "–ë–µ–∑—É–º–Ω—ã–π", "–•–∏—Ç—Ä—ã–π", "–°–æ–ª–µ–Ω—ã–π", "–°–∫–∞–ª–∏—Å—Ç—ã–π",
    "–ë—É—Ä—è–Ω–æ–π", "–û–≥–Ω–µ–Ω–Ω—ã–π", "–ù–æ—á–Ω–æ–π", "–ì—Ä–æ–∑–æ–≤–æ–π", "–õ–µ–¥—è–Ω–æ–π",
    "–Ø—Ä–æ—Å—Ç–Ω—ã–π", "–í–µ—Ç—Ä—è–Ω–æ–π", "–ü—Ä–∏–∑—Ä–∞—á–Ω—ã–π", "–õ—É–Ω–Ω—ã–π", "–ê–¥—Å–∫–∏–π",
    "–ö–æ—Ä–æ–ª–µ–≤—Å–∫–∏–π", "–ë–µ—Å—Å—Ç—Ä–∞—à–Ω—ã–π", "–°–≤–µ—Ç–ª—ã–π", "–ë—Ä–æ–Ω–∑–æ–≤—ã–π", "–ß—É–º–Ω–æ–π",
    "–ú—Ä–∞—á–Ω—ã–π", "–ü—ã–ª–∞—é—â–∏–π", "–ü–µ—Å—á–∞–Ω—ã–π", "–ö–æ—Å—Ç—è–Ω–æ–π", "–ë–æ–ª–æ—Ç–Ω—ã–π",
    "–¢—ë–º–Ω—ã–π", "–ë—É—Ä–µ–≤–µ—Å—Ç–Ω—ã–π", "–û–±–ª–∞—á–Ω—ã–π", "–û—Ö–æ—Ç–Ω–∏—á–∏–π", "–°–Ω–µ–∂–Ω—ã–π",
    "–ú–æ–ª–Ω–∏–µ–Ω–æ—Å–Ω—ã–π", "–°–æ–ª–Ω–µ—á–Ω—ã–π", "–ì–æ–ª–æ–¥–Ω—ã–π", "–¢–∏—Ö–∏–π", "–ë–µ—Å–ø–æ—â–∞–¥–Ω—ã–π",
    "–õ—é—Ç—ã–π", "–°—Ç–∞–ª—å–Ω–æ–π", "–ë–ª–µ–¥–Ω—ã–π", "–ö–æ–≤–∞—Ä–Ω—ã–π", "–ë–µ—Å—Å–º–µ—Ä—Ç–Ω—ã–π",
    "–ì—Ä–æ–∑—è—â–∏–π", "–ö—Ä—ã–ª–∞—Ç—ã–π", "–í–µ—á–Ω—ã–π", "–ú–µ—Ä—Ç–≤–µ–Ω–Ω—ã–π", "–ë—É—à—É—é—â–∏–π",
    "–î—É—Ö–æ–≤–Ω—ã–π", "–í–∏—Ö—Ä–µ–≤–æ–π", "–¢—Ä—ë—Ö–≥–ª–∞–≤—ã–π", "–ó–≤—ë–∑–¥–Ω—ã–π", "–û–≥—Ä–æ–º–Ω—ã–π",
    "–ß—ë—Ä—Å—Ç–≤—ã–π", "–†–∞–∑—Ä—É—à–∏—Ç–µ–ª—å–Ω—ã–π", "–¢–∏—Ç–∞–Ω–∏—á–µ—Å–∫–∏–π", "–î—Ä–µ–≤–Ω–∏–π", "–í–æ–¥—è–Ω–æ–π",
    "–ì–æ—Ä—è—â–∏–π", "–ö–∞–º–µ–Ω–Ω—ã–π", "–†–æ–∫–æ–≤–æ–π", "–ü—ã–ª—å–Ω—ã–π", "–°–≤–µ—Ç—è—â–∏–π—Å—è",
    "–ü–µ–ø–µ–ª—å–Ω—ã–π", "–ì–∏–±–µ–ª—å–Ω—ã–π", "–ú–æ—Ä–æ–∑–Ω—ã–π", "–¢—Ä–æ–ø–∏—á–µ—Å–∫–∏–π", "–õ–µ—Å–Ω–æ–π",
    "–•–æ–ª–æ–¥–Ω—ã–π", "–ë–ª–∞–≥–æ—Ä–æ–¥–Ω—ã–π", "–ú–µ–¥–Ω—ã–π", "–û—Å–ª–µ–ø–∏—Ç–µ–ª—å–Ω—ã–π", "–ê–ª–º–∞–∑–Ω—ã–π",
    "–°–∫–≤–æ–∑–Ω–æ–π", "–ì—Ä–æ–∑–æ–≤–æ–π", "–ß—ë—Ä–Ω—ã–π", "–ö—Ä–∏—Å—Ç–∞–ª—å–Ω—ã–π", "–¢—É–º–∞–Ω–Ω—ã–π",
    "–ü—å—è–Ω—è—â–∏–π", "–ñ–∞—Ä–∫–∏–π", "–ñ–µ—Å—Ç–æ–∫–∏–π", "–ó–ª–æ–≤–µ—â–∏–π", "–ë—É—Ä–ª—è—â–∏–π"
]

# –û—Å–Ω–æ–≤—ã
bases = [
    "–î–∂–µ–∫", "–≠–Ω–Ω", "–ú–æ—Ä–≥–∞–Ω", "–ö—Ä—é–∫", "–§–ª–∏–Ω—Ç", "–í–æ—Ä–æ–Ω",
    "–ö–ª—ã–∫", "–ö–æ—Å—Ç—è–Ω–æ–π", "–ë–æ—Ä–æ–¥–∞", "–†–µ–π–≤–µ–Ω", "–í–æ–ª–∫", "–ö–∞—Ä–∞–±–∏–Ω",
    "–®–ø–∞–≥–∞—Ç", "–û—Ö–æ—Ç–Ω–∏–∫", "–ú–æ—Ä—Å–∫–æ–π", "–†–∞–∑–±–æ–π–Ω–∏–∫", "–ö–∞–ø–∏—Ç–∞–Ω",
    "–Ø—Å—Ç—Ä–µ–±", "–ó–º–µ—è", "–¢–∏–≥—Ä", "–û—Ä–µ–ª", "–¢–∞—Ä–∞–Ω", "–õ–∞–Ω—Å",
    "–í–∞—Ä–≤–∞—Ä", "–ë–∞—Ä–æ–Ω", "–î—Ä–∞–∫–æ–Ω", "–õ–∞–Ω—Å–µ—Ä", "–ö–æ—á–µ–≤–Ω–∏–∫",
    "–ê–∫—É–ª–∞", "–¢–∞—Ä–∞–Ω—Ç—É–ª", "–°–æ–∫–æ–ª", "–í–æ–∂–¥—å", "–ú–µ–¥–≤–µ–¥—å",
    "–ì—Ä–∏—Ñ–æ–Ω", "–ü–∏—Ä–∞—Ç", "–ì–ª–∞–¥–∏–∞—Ç–æ—Ä", "–í—Å–∞–¥–Ω–∏–∫", "–ü—Ä–∏–∑—Ä–∞–∫",
    "–®—Ç—É—Ä–º–∞–Ω", "–ì–∞—Ä–ø—É–Ω", "–ó–≤–µ—Ä—å", "–¢–µ–Ω—å", "–ö–∏—Ç–æ–±–æ–π",
    "–°—Ç—Ä–µ–ª–æ–∫", "–ë–∞–Ω–¥–∏—Ç", "–¢—é–ª–µ–Ω—å", "–®–∞–º–∞–Ω", "–°–∞–ø—Å–∞–Ω",
    "–ö–æ—Ä—Å–∞—Ä", "–°–æ–∫–æ–ª", "–°–∞–ª–∞–º–∞–Ω–¥—Ä–∞", "–ß—É–¥–æ–≤–∏—â–µ", "–õ–µ–≥–∏–æ–Ω–µ—Ä",
    "–õ–µ–≤", "–ü–∞–ª–∞—á", "–¢—Ä–∏—Ç–æ–Ω", "–ú–∏–Ω–æ—Ç–∞–≤—Ä", "–ì—Ä–æ–º–æ–≤–µ—Ä–∂–µ—Ü",
    "–û–ª–µ–Ω—å", "–°—Ç—Ä–∞–Ω–Ω–∏–∫", "–°–∏—Ä–µ–Ω–∞", "–û—Ö–æ—Ç–Ω–∏–∫", "–ê—Ä–±–∞–ª–µ—Ç—á–∏–∫",
    "–ë—ã–∫", "–ß—ë—Ä—Ç", "–ó–æ–¥—á–∏–π", "–•–∏—â–Ω–∏–∫", "–î–µ–ª—å—Ñ–∏–Ω",
    "–ó–≤–µ—Ä–æ–ª–æ–≤", "–ó–≤–µ—Ä–æ–±–æ–π", "–ú–∞—Å—Ç–µ—Ä", "–¢–∫–∞—á", "–ì–æ–Ω—á–∞—Ä",
    "–°–æ–∫–æ–ª", "–ú–æ—Ä–∂", "–ê–ª—å–±–∞—Ç—Ä–æ—Å", "–û—Ä–ª–∞–Ω", "–î–µ—Ä–≤–∏—à",
    "–í–µ—Ç–µ—Ä", "–õ–µ—Ç—É—á–∏–π", "–•—Ä–∞–Ω–∏—Ç–µ–ª—å", "–ú–æ–ª–æ—Ç", "–ì–∏–≥–∞–Ω—Ç",
    "–ë—ã–∫", "–®–∏–ø", "–ó–º–µ–π", "–†—ã—Å—å", "–ü–∞—Å—Ç—ã—Ä—å",
    "–ú–æ—Ä—è–∫", "–°—Ç–∞—Ä–µ–π—à–∏–Ω–∞", "–ü–∞–Ω—Ç–µ—Ä–∞", "–®—Ç–æ—Ä–º", "–í–æ–µ–≤–æ–¥–∞"
]


def generate_pirate_name():
    nickname = random.choice(nicknames)
    base = random.choice(bases)
    return f"{nickname} {base}"


class Character:
    def __init__(self, lid = False, bon = 0):
        """

        :param lid: –õ–∏–¥–µ—Ä –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ –ø–æ–ª—É—á–∏—Ç –Ω–∞–≤—ã–∫ + –Ω–∞ –∫–æ—Ä–∞–±–ª–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ç–æ–ª—å–∫–æ 1 –ª–∏–¥–µ—Ä, –≤ —Å–ª—É—á–∞–µ –µ—Å–ª–∏ –∏—Ö –≤–æ–∑–Ω–∏–∫–∞–µ—Ç 2 —Ç–æ –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –ª—É—á—à–∏–π
        :param bon: –î–æ–±–∞–≤–ª—è–µ—Ç —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∫ –±–∞–∑–æ–≤—ã–º 5 –±–æ–Ω—É—Å–∞–º
        """

        self.name = generate_pirate_name()
        self.skill = None

        point = 5 + bon

        self.lid = lid

        self.control = 1
        self.harvest = 1
        self.attack = 1
        self.survival = 1
        self.stamina = 1

        while point > 0:
            if random.randint(1,6) == 1:
                self.control += 1
            elif random.randint(1,5) == 1:
                self.harvest += 1
            elif random.randint(1,4) == 1:
                self.attack += 1
            elif random.randint(1,3) == 1:
                self.survival += 1
            else:
                self.stamina += 2
            point -= 1
        self.__skill_gen()





    def __skill_gen(self):
        if random.randint(1,100) == 1 or self.lid:
            if random.randint(1,100) == 1:
                self.skill = random.choice(skill['leg'])
            elif random.randint(1,1000) < 101:
                self.skill = random.choice(skill['rare'])
            else:
                self.skill = random.choice(skill['simple'])

        if self.skill == '–ë–æ–µ—Ü':
            self.attack += 1
        elif self.skill == '–ú–µ—Ä—Ç–≤–µ—Ü':
            self.stamina = max(1,int(self.stamina/2))
            self.survival *= 2
        elif self.skill == '–ë–æ–≥ –º–æ—Ä–µ–π':
            self.control += 3









------------------------------------------------------------
models\world_objects\game_object.py:

class GameObject:
    def __init__(self, position, rotation = 0, image_path = None):
        self.position = position
        self.rotation = rotation
        self.image_path = image_path




------------------------------------------------------------
models\world_objects\island.py:
from core.vector2 import Vector2
from models.world_objects.game_object import GameObject


class Island(GameObject):
    def __init__(self, position, local_points=None, local_visual_points=None):
        if local_visual_points is None:
            local_visual_points = [(0.5, 0.5), (-0.5, 0.5), (-0.5, -0.5), (0.5, -0.5)]
        if local_points is None:
            local_points = [Vector2(0, 0)]

        super().__init__(position)
        self.local_points = local_points
        self.local_visual_points = local_visual_points




------------------------------------------------------------
models\world_objects\monster.py:
from models.world_objects.game_object import GameObject


class Monster(GameObject):
    def __init__(self, position, rotation, sprite_name, max_hp, view_range = 3, freeze_rotation=False, updates_to_move = 1):
        super().__init__(position, rotation)




------------------------------------------------------------
models\world_objects\ship.py:
from core.images_operator import get_image_path_from_ship_name
from core.vector2 import Vector2
from models.user import User
from models.world_objects.game_object import GameObject
from models.world_objects.Character import Character


# –ö–ª–∞—Å—Å –∫–æ—Ä–∞–±–ª—è, —Ö—Ä–∞–Ω—è—â–∏–π –µ–≥–æ —Å—Ç–∞—Ç—ã
class Ship(GameObject):
    def __init__(self, position, rotation, sprite_name, max_hp = 100, view_range = 4):
        """
        :param position: –°—Ç–∞—Ä—Ç–æ–≤–∞—è –ø–æ–∑–∏—Ü–∏—è
        :param rotation: –°—Ç–∞—Ä—Ç–æ–≤—ã–π –ø–æ–≤–æ—Ä–æ—Ç
        :param sprite_name: –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç—É—Ä—ã
        :param max_hp: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ –•–ü
        :param view_range: –†–∞–¥–∏—É—Å –æ–±–∑–æ—Ä–∞ –≤ –∫–ª–µ—Ç–∫–∞—Ö (—Ü–µ–ª–æ–µ)
        """
        super().__init__(position, rotation, get_image_path_from_ship_name(sprite_name))
        self.owner = None
        self.max_hp = max_hp
        self.hp = max_hp
        self.view_range = view_range

        self.onboard_team = []

        self.onboard_team.append(Character(True, 1))
        self.onboard_team.append(Character())
        self.onboard_team.append(Character())

    def register_owner(self, owner):
        """–†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞ –∫–æ—Ä–∞–±–ª—è"""
        self.owner = owner
        if type(owner) == User:
            breakpoint()
            owner.controlled_ship = self
        else:
            print("\n"*10)
            print("$ Warning : The owner of the ship is not User (ship.py)")
            print("\n" * 3)


    def move(self, direction):
        self.rotation = direction
        match direction:
            case 0:  # –í–≤–µ—Ä—Ö
                self.position.add(Vector2(0, 1))
            case 45:
                self.position.add(Vector2(-1, 1))
            case -45:
                self.position.add(Vector2(1, 1))
            case 90:
                self.position.add(Vector2(-1, 0))
            case -90:
                self.position.add(Vector2(1, 0))
            case 135:
                self.position.add(Vector2(-1, -1))
            case -135:
                self.position.add(Vector2(1, -1))
            case 180:
                self.position.add(Vector2(0, -1))


    def take_damage(self,damage):
        """
        –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ—Ä–∞–±–ª—ë–º —É—Ä–æ–Ω–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–µ.
        :param damage: –¶–µ–ª–æ–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ
        :return: —É–¥–∞–ª–æ—Å—å –ª–∏ —ç—Ç–æ–π –∞—Ç–∞–∫–µ —É–Ω–∏—á—Ç–æ–∂–∏—Ç—å –∫–æ—Ä–∞–±–ª—å
        """
        self.hp -= damage
        if self.hp < 0:
            return True
        else:
            return False
        # –ü—Ä–∏ hp <= 0 –∫–æ—Ä–∞–±–ª—å –¥–æ–ª–∂–µ–Ω –ø–æ–ª—É—á–∞—Ç—å —É—Ä–æ–Ω –∑–∞ –∫–∞–∂–¥–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —Å —à–∞–Ω—Å–æ–º, –∑–∞–≤–∏—Å—è—â–∏–º –æ—Ç –æ–ø—ã—Ç–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞–ø–∏—Ç–∞–Ω–∞






------------------------------------------------------------
network\async_messages_operator.py:
from variables.bot import bot
import asyncio
from aiogram.types import Message, InputMediaPhoto
import random
from core import images_operator


async def try_delete_message(chat_id, message_id) -> bool:
    try:
        await bot.delete_message(chat_id=chat_id, message_id=message_id)
        return True
    except Exception as exception:
        print(f'$ Warning - message {message_id} in chat {chat_id} cannot be deleted: {exception}')
        return False


async def try_edit_message_text(chat_id, message_id, new_message_text) -> bool:
    try:
        await bot.edit_message_text(chat_id=chat_id, message_id=message_id, text=new_message_text)
        return True
    except Exception as exception:
        print(f"$ Warning - message's {message_id} text in chat {chat_id} cannot be edited to '{new_message_text}': {exception}")
        return False

'''async def test_edit():
    message_id = 0
    while True:
        await asyncio.sleep(1)
        result, new_message_id = await try_strong_edit_message_media(5609117794,
                                                               message_id,
                                                               f"–ê–±–æ–±—É—Å {random.randint(0, 100)}",
                                                               images_operator.get_image_from_ship_name(f"ship {random.randint(1, 5)}"),
                                                               max_edit_wait_time=1)
        if result:
            message_id = new_message_id
        else:
            print("–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ")
            break'''

async def try_strong_edit_message_media(
    chat_id,
    message_id,
    new_caption=None,
    new_photo=None,
    new_reply_markup=None,
    max_edit_wait_time=1
) -> (bool, int):
    """
    –ò–∑–º–µ–Ω—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ, –ø—Ä–∏ –Ω–µ—É–¥–∞—á–µ –ø—ã—Ç–∞–µ—Ç—Å—è —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —Å message_id –∏ –≤—ã—Å–ª–∞—Ç—å –Ω–æ–≤–æ–µ(–≤ —Ç–∞–∫–æ–º —Å–ª—É—á–∞–µ –≤–µ—Ä–Ω—ë—Ç id –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è, –∏–Ω–∞—á–µ - –∏–∑–º–µ–Ω—ë–Ω–Ω–æ–≥–æ)
    :param chat_id: id —á–∞—Ç–∞
    :param message_id: id —Å–æ–æ–±—â–µ–Ω–∏—è
    :param new_caption: –Ω–æ–≤–∞—è –ø–æ–¥–ø–∏—Å—å
    :param new_photo: –Ω–æ–≤–æ–µ —Ñ–æ—Ç–æ
    :param new_reply_markup: –Ω–æ–≤—ã–π reply_markup
    :param max_edit_wait_time: –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è(–ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ø–µ—Ä–µ–≤—ã—à–ª–µ—Ç—Å—è)
    :return: —É–¥–∞—á–Ω–æ –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–æ, id –∏–∑–º–µ–Ω—ë–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è(–æ–Ω–æ –º–æ–≥–ª–æ –∏–∑–º–µ–Ω–∏—Ç—å—Å—è)
    """
    try:
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        if new_photo is not None:
            task = asyncio.create_task(
                bot.edit_message_media(
                    chat_id=chat_id,
                    message_id=message_id,
                    media=InputMediaPhoto(media=new_photo, caption=new_caption),
                    reply_markup=new_reply_markup
                )
            )
        else:
            task = asyncio.create_task(
                bot.edit_message_caption(
                    chat_id=chat_id,
                    message_id=message_id,
                    caption=new_caption,
                    reply_markup=new_reply_markup
                )
            )

        # –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö max_edit_wait_time
        done, pending = await asyncio.wait([task], timeout=max_edit_wait_time)

        # –ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å
        try:
            if task in done:
                await task  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
                print("–£—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–æ")
                return True, message_id
        except:
            pass

        # –ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å, –æ—Ç–º–µ–Ω—è–µ–º –µ–µ –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º
        for pending_task in pending:
            pending_task.cancel()

        print("–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ, –ø–µ—Ä–µ–≤—ã—Å—ã–ª–∞—é...")

        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        try:
            asyncio.create_task(try_delete_message(chat_id=chat_id, message_id=message_id))
        except:
            pass

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        if new_photo is not None:
            new_message: Message = await bot.send_photo(
                chat_id=chat_id,
                photo=new_photo,
                caption=new_caption,
                reply_markup=new_reply_markup
            )
        else:
            return False, None

        print("–ü–µ—Ä–µ–≤—ã—Å–ª–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ")
        return True, new_message.message_id

    except Exception as exception:
        print(f"$ Warning - message's {message_id} in chat {chat_id} could not be edited or replaced: {exception}")
        return False, None




------------------------------------------------------------
network\call_reaction.py:
from variables.event_manager import call_event
from variables.bot import  dp
from core.users_list import users_dict
from models.user import User

#–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–∞
@dp.callback_query()
async def text_receiver(message):
    if message.message.chat.id > 0:
        if not message.message.chat.id in users_dict.keys():
            User(message.message.chat.id)
        call_event.trigger(message = message)
    else:
        await message.message.bot.send_message(message.message.chat.id, "–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ –≤ —á–∞—Ç–∞—Ö")




------------------------------------------------------------
network\text_reaction.py:
import asyncio

from variables.event_manager import text_event
from variables.bot import  dp
from aiogram.filters import Command
from aiogram import types
from core.users_list import users_dict
from models.user import User
from network import async_messages_operator

#–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–∞
@dp.message()
async def text_receiver(message: types.Message):
    asyncio.create_task(async_messages_operator.try_delete_message(message.chat.id, message.message_id))
    if message.chat.id > 0:
        if not message.chat.id in users_dict.keys():
            User(message.chat.id)
        text_event.trigger(message = message)
    else:
        await message.bot.send_message(message.chat.id, "–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ –≤ —á–∞—Ç–∞—Ö")






------------------------------------------------------------
settings\global_settings.py:
from settings import not_synchronized

token = not_synchronized.bot_token
render_out_of_border_range = 0  # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ—Ä–∏—Å–æ–≤–∫–∞ –∑–∞ –∫—Ä–∞—è–º–∏ –∫–∞—Ä—Ç—ã. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω–∞ 0, –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ, —á—Ç–æ–±—ã –∏–≥—Ä–æ–∫ –Ω–∏–∫–∞–∫ –Ω–µ –º–æ–≥ —É–≤–∏–¥–µ—Ç—å, —á—Ç–æ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –∑–∞ –∫—Ä–∞—è–º–∏ –µ–≥–æ –ø–æ–ª—è –∑—Ä–µ–Ω–∏—è –∏ –Ω–∞ 1, –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –æ—Å—Ç–∞–≤–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —É–≤–∏–¥–µ—Ç—å –≤—ã–≥–ª—è–¥—ã–≤–∞—é—â–∏–π –æ–±—ä–µ–∫—Ç –∏–∑-–∑–∞ –∫—Ä–∞—ë–≤ –∫–∞—Ä—Ç—ã



------------------------------------------------------------
settings\not_synchronized.py:
# –≠—Ç–æ—Ç —Ñ–∞–π–ª –Ω–µ –¥–æ–ª–∂–µ–Ω —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤ –±–æ—Ç–µ
bot_token = '7341501133:AAEToBm5cNmHILAYMRdKbOnKdrzxYkHkjDI'



------------------------------------------------------------
settings\special_persons.py:

# 5023003261 - Loki, 5609117794 - Lomi, 6843891842 - –ó–µ–Ω–æ–Ω, 5125398596 - jon1k, 498216118 - üôáüèº‚Äç‚ôÇÔ∏èDimarikannüôáüèº‚Äç‚ôÇÔ∏è, 6014738757 - Ekwensu
admins = [5609117794, 5023003261, 6014738757]
developers = [5609117794, 5023003261]




------------------------------------------------------------
UI\inline_keyboard_buttons.py:
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton


ship_control_buttons = InlineKeyboardMarkup(
    inline_keyboard=[
        [InlineKeyboardButton(text="‚¨â", callback_data="‚¨â"),InlineKeyboardButton(text="‚Üë", callback_data="‚Üë"),InlineKeyboardButton(text="‚¨à", callback_data="‚¨à")],
        [InlineKeyboardButton(text="‚Üê", callback_data="‚Üê"),InlineKeyboardButton(text="üîµ", callback_data="üîµ"),InlineKeyboardButton(text="‚Üí", callback_data="‚Üí")],
        [InlineKeyboardButton(text="‚¨ã", callback_data="‚¨ã"),InlineKeyboardButton(text="‚Üì", callback_data="‚Üì"),InlineKeyboardButton(text="‚¨ä", callback_data="‚¨ä")],
    ]
)

cancel_button = InlineKeyboardMarkup(
    inline_keyboard=[
        [InlineKeyboardButton(text="–û—Ç–º–µ–Ω–∞ üö´", callback_data="cancel")]
    ]
)


"""–û–¥–Ω–æ—Ç–æ–Ω–Ω—ã–µ –∫–≤–∞–¥—Ä–∞—Ç—ã:
‚óºÔ∏è –ß–µ—Ä–Ω—ã–π –∫–≤–∞–¥—Ä–∞—Ç
‚óªÔ∏è –ë–µ–ª—ã–π –∫–≤–∞–¥—Ä–∞—Ç
‚ñ™Ô∏è –ú–∞–ª–µ–Ω—å–∫–∏–π —á–µ—Ä–Ω—ã–π –∫–≤–∞–¥—Ä–∞—Ç
‚ñ´Ô∏è –ú–∞–ª–µ–Ω—å–∫–∏–π –±–µ–ª—ã–π –∫–≤–∞–¥—Ä–∞—Ç
–¶–≤–µ—Ç–Ω—ã–µ –∫–≤–∞–¥—Ä–∞—Ç—ã:
üî¥ –ö—Ä–∞—Å–Ω—ã–π –∫–≤–∞–¥—Ä–∞—Ç
üü† –û—Ä–∞–Ω–∂–µ–≤—ã–π –∫–≤–∞–¥—Ä–∞—Ç
üü° –ñ–µ–ª—Ç—ã–π –∫–≤–∞–¥—Ä–∞—Ç
üü¢ –ó–µ–ª–µ–Ω—ã–π –∫–≤–∞–¥—Ä–∞—Ç
üîµ –°–∏–Ω–∏–π –∫–≤–∞–¥—Ä–∞—Ç
üü£ –§–∏–æ–ª–µ—Ç–æ–≤—ã–π –∫–≤–∞–¥—Ä–∞—Ç
üü§ –ö–æ—Ä–∏—á–Ω–µ–≤—ã–π –∫–≤–∞–¥—Ä–∞—Ç
‚ö´ –ß–µ—Ä–Ω—ã–π (–∫—Ä—É–≥–ª—ã–π) –∫–≤–∞–¥—Ä–∞—Ç
‚ö™ –ë–µ–ª—ã–π (–∫—Ä—É–≥–ª—ã–π) –∫–≤–∞–¥—Ä–∞—Ç
–ì—Ä–∞–Ω–∏—Ü—ã:
‚¨õ –ß–µ—Ä–Ω—ã–π –±–æ–ª—å—à–æ–π –∫–≤–∞–¥—Ä–∞—Ç
‚¨ú –ë–µ–ª—ã–π –±–æ–ª—å—à–æ–π –∫–≤–∞–¥—Ä–∞—Ç"""



------------------------------------------------------------
UI\keyboard_buttons.py:
from aiogram import types
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton

button_map = ReplyKeyboardMarkup(
            keyboard=[
                [KeyboardButton(text="–ö–∞—Ä—Ç–∞ üó∫")]
            ],
            resize_keyboard=True  # –£–º–µ–Ω—å—à–∞–µ–º —Ä–∞–∑–º–µ—Ä –∫–Ω–æ–ø–∫–∏
        )



------------------------------------------------------------
UI\map_visualizer.py:
import math
import time
import cv2
import numpy as np
from aiogram import types
import random
import asyncio

from UI import inline_keyboard_buttons
from core import images_operator
from core.maps_list import maps
from core.users_list import users_id
from core.vector2 import Vector2
from models.world_objects.ship import Ship
from network.async_messages_operator import try_delete_message
from variables.bot import bot
from settings.global_settings import render_out_of_border_range
from network import async_messages_operator

def create_background(width, height, color=(252, 141, 56)):  # RGB –≤–º–µ—Å—Ç–æ HEX
    """–°–æ–∑–¥–∞–Ω–∏–µ —Ñ–æ–Ω–∞."""
    return np.full((height, width, 3), color, dtype=np.uint8)


def render_visible_objects(base_image, map_, player_ship):
    """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∏–º—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ."""
    full_view_range = player_ship.view_range + render_out_of_border_range
    min_visible_pos = player_ship.position.summ(Vector2(-full_view_range, -full_view_range))
    max_visible_pos = player_ship.position.summ(Vector2(full_view_range, full_view_range))
    resolution = base_image.shape[0]
    pixels_in_cell = resolution / (player_ship.view_range * 2 + 1)

    for object_ in map_.objects:
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ç–æ, –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –ª–∏ –æ–±—ä–µ–∫—Ç –≤ –ø–æ–ª–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏
        if min_visible_pos.x <= object_.position.x <= max_visible_pos.x and min_visible_pos.y <= object_.position.y <= max_visible_pos.y:
            relative_cells_pos = object_.position.summ(Vector2(-player_ship.position.x, -player_ship.position.y))
            pixels_pos = Vector2(relative_cells_pos.x * pixels_in_cell, -relative_cells_pos.y * pixels_in_cell).summ(Vector2(resolution / 2, resolution / 2))
            add_object(base_image, object_, pixels_pos, object_.rotation, pixels_in_cell)


def add_object(base_image, object_, position, rotation, pixels_in_cell):
    """–†–µ–Ω–¥–µ—Ä–∏—Ç –æ–¥–∏–Ω –æ—Ç–¥–µ–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º–∏ –ø–æ–∑–∏—Ü–∏–µ–π –≤ –ø–∏–∫—Å–µ–ª—è—Ö(0, 0 = –ª–µ–≤—ã–π –≤–µ—Ä—Ö–Ω–∏–π —É–≥–æ–ª) –∏ –ø–æ–≤–æ—Ä–æ—Ç–æ–º –≤ –≥—Ä–∞–¥—É—Å–∞—Ö"""
    object_type = type(object_)

    if object_type == Ship:
        # –ü–æ–ª—É—á–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ—Ä–∞–±–ª—è –≤ –Ω—É–∂–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
        ship_img = images_operator.get_cv2_image_from_path(object_.image_path)

        # –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ—Ä–∞–±–ª—è
        additive_scale = 1.1  # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ —á—Ç–æ–±—ã –∫–∞—Ä—Ç–∏–Ω–∫–∞ —Å–ª–µ–≥–∫–∞ –≤—ã–ª–∞–∑–∏–ª–∞ –∑–∞ –≥—Ä–∞–Ω–∏ —è—á–µ–π–∫–∏)
        scale = pixels_in_cell / max(ship_img.shape[0], ship_img.shape[1])

        add_image(base_image, ship_img, position, rotation, scale * additive_scale)


def add_image(base_image, image, position, rotation=0, scale=1.0):
    """
    –î–æ–±–∞–≤–ª—è–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ base_image —Å —É—á–µ—Ç–æ–º –ø–æ–∑–∏—Ü–∏–∏, –ø–æ–≤–æ—Ä–æ—Ç–∞ –∏ –º–∞—Å—à—Ç–∞–±–∞.

    :param base_image: –û—Å–Ω–æ–≤–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (numpy array).
    :param image: –ù–∞–∫–ª–∞–¥—ã–≤–∞–µ–º–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (numpy array —Å –∞–ª—å—Ñ–∞-–∫–∞–Ω–∞–ª–æ–º).
    :param position: –¶–µ–Ω—Ç—Ä –Ω–∞–ª–æ–∂–µ–Ω–∏—è Vector2(x, y) –Ω–∞ base_image.
    :param rotation: –£–≥–æ–ª –ø–æ–≤–æ—Ä–æ—Ç–∞ (–≤ –≥—Ä–∞–¥—É—Å–∞—Ö).
    :param scale: –ú–∞—Å—à—Ç–∞–± –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.
    """
    # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –∞–ª—å—Ñ–∞-–∫–∞–Ω–∞–ª–æ–º
    if image.shape[2] != 4:
        raise ValueError("–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∞–ª—å—Ñ–∞-–∫–∞–Ω–∞–ª (4 –∫–∞–Ω–∞–ª–∞)")

    # –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    new_size = (int(image.shape[1] * scale), int(image.shape[0] * scale))
    scaled_image = cv2.resize(image, new_size, interpolation=cv2.INTER_LANCZOS4)

    # –ü–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    center = (scaled_image.shape[1] // 2, scaled_image.shape[0] // 2)
    rotation_matrix = cv2.getRotationMatrix2D(center, rotation, 1)
    rotated_image = cv2.warpAffine(
        scaled_image,
        rotation_matrix,
        (scaled_image.shape[1], scaled_image.shape[0]),
        flags=cv2.INTER_LINEAR,
        borderMode=cv2.BORDER_CONSTANT,
        borderValue=(0, 0, 0, 0)
    )

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–∑–∏—Ü–∏–∏ –≤—Å—Ç–∞–≤–∫–∏
    x, y = int(position.x - rotated_image.shape[1] / 2), int(position.y - rotated_image.shape[0] / 2)

    # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤—Å—Ç–∞–≤–∫–∏ –Ω–µ –≤—ã—Ö–æ–¥—è—Ç –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã base_image
    x_start, x_end = max(0, x), min(base_image.shape[1], x + rotated_image.shape[1])
    y_start, y_end = max(0, y), min(base_image.shape[0], y + rotated_image.shape[0])

    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è cropped region
    crop_x_start = max(0, -x)
    crop_x_end = crop_x_start + (x_end - x_start)
    crop_y_start = max(0, -y)
    crop_y_end = crop_y_start + (y_end - y_start)

    # –ò–∑–≤–ª–µ–∫–∞–µ–º –∞–ª—å—Ñ–∞-–∫–∞–Ω–∞–ª –∏ –≤—ã–ø–æ–ª–Ω—è–µ–º –Ω–∞–ª–æ–∂–µ–Ω–∏–µ
    alpha = rotated_image[crop_y_start:crop_y_end, crop_x_start:crop_x_end, 3] / 255.0
    for c in range(3):  # –ö–∞–Ω–∞–ª—ã RGB
        base_image[y_start:y_end, x_start:x_end, c] = (
            alpha * rotated_image[crop_y_start:crop_y_end, crop_x_start:crop_x_end, c] +
            (1 - alpha) * base_image[y_start:y_end, x_start:x_end, c]
        )


def add_grid(
    base_image,
    cell_count,
    grid_thickness_ratio=0.002,  # –¢–æ–ª—â–∏–Ω–∞ –ª–∏–Ω–∏–π –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —à–∏—Ä–∏–Ω—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    grid_color=(0, 0, 0, 100),  # –¶–≤–µ—Ç —Å–µ—Ç–∫–∏ (RGBA)
    text_color=(0, 0, 0, 100),  # –¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ (RGBA)
    font_scale_ratio=0.001,  # –†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —à–∏—Ä–∏–Ω—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    font_thickness_ratio=0.0025,  # –¢–æ–ª—â–∏–Ω–∞ —Ç–µ–∫—Å—Ç–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —à–∏—Ä–∏–Ω—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    text_offset_ratio=0.005  # –û—Ç—Å—Ç—É–ø —Ç–µ–∫—Å—Ç–∞ –æ—Ç –≥—Ä–∞–Ω–∏—Ü –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
):
    """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ç–∫–∏ —Å –±—É–∫–≤–∞–º–∏ –∏ —Ü–∏—Ñ—Ä–∞–º–∏ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ."""
    height, width = base_image.shape[:2]
    cell_width = width // cell_count
    cell_height = height // cell_count

    # –ê–±—Å–æ–ª—é—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è —Ç–æ–ª—â–∏–Ω—ã –ª–∏–Ω–∏–π, —Ä–∞–∑–º–µ—Ä–∞ –∏ —Ç–æ–ª—â–∏–Ω—ã —Ç–µ–∫—Å—Ç–∞
    grid_thickness = max(1, int(grid_thickness_ratio * width))
    font_scale = font_scale_ratio * width
    font_thickness = max(1, int(font_thickness_ratio * width))
    text_offset = int(text_offset_ratio * width)

    # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–ª–æ–∏
    grid_layer = base_image.copy()
    text_layer = base_image.copy()

    # –†–∏—Å—É–µ–º –ª–∏–Ω–∏–∏ —Å–µ—Ç–∫–∏
    for i in range(1, cell_count):
        x = i * cell_width
        y = i * cell_height

        # –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
        cv2.line(grid_layer, (x, 0), (x, height), grid_color[:3], grid_thickness, lineType=cv2.LINE_AA)

        # –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
        cv2.line(grid_layer, (0, y), (width, y), grid_color[:3], grid_thickness, lineType=cv2.LINE_AA)

    # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç (–±—É–∫–≤—ã —Å–≤–µ—Ä—Ö—É –∏ —Å–Ω–∏–∑—É, —Ü–∏—Ñ—Ä—ã —Å–ª–µ–≤–∞ –∏ —Å–ø—Ä–∞–≤–∞)
    for i in range(cell_count):
        letter = chr(65 + i)  # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –±—É–∫–≤ 'A', 'B', ...
        number = str(i + 1)   # –¶–∏—Ñ—Ä—ã –æ—Ç 1 –¥–æ cell_count

        # –ü–æ–∑–∏—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞
        letter_x = int(i * cell_width + cell_width / 2)
        letter_top_y = text_offset
        letter_bottom_y = height - text_offset

        number_y = int(i * cell_height + cell_height / 2)
        number_left_x = text_offset
        number_right_x = width - text_offset

        # –¶–µ–Ω—Ç—Ä–æ–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞ –ø–æ –≥—Ä–∞–Ω–∏—Ü–µ
        letter_size = cv2.getTextSize(letter, cv2.FONT_HERSHEY_SIMPLEX, font_scale, font_thickness)[0]
        number_size = cv2.getTextSize(number, cv2.FONT_HERSHEY_SIMPLEX, font_scale, font_thickness)[0]

        # –†–∏—Å—É–µ–º –±—É–∫–≤—ã —Å–≤–µ—Ä—Ö—É –∏ —Å–Ω–∏–∑—É
        cv2.putText(
            text_layer, letter,
            (letter_x - letter_size[0] // 2, letter_top_y + letter_size[1]),
            cv2.FONT_HERSHEY_SIMPLEX, font_scale, text_color[:3], font_thickness, lineType=cv2.LINE_AA
        )
        cv2.putText(
            text_layer, letter,
            (letter_x - letter_size[0] // 2, letter_bottom_y),
            cv2.FONT_HERSHEY_SIMPLEX, font_scale, text_color[:3], font_thickness, lineType=cv2.LINE_AA
        )

        # –†–∏—Å—É–µ–º —Ü–∏—Ñ—Ä—ã —Å–ª–µ–≤–∞ –∏ —Å–ø—Ä–∞–≤–∞
        cv2.putText(
            text_layer, number,
            (number_left_x, number_y + number_size[1] // 2),
            cv2.FONT_HERSHEY_SIMPLEX, font_scale, text_color[:3], font_thickness, lineType=cv2.LINE_AA
        )
        cv2.putText(
            text_layer, number,
            (number_right_x - number_size[0], number_y + number_size[1] // 2),
            cv2.FONT_HERSHEY_SIMPLEX, font_scale, text_color[:3], font_thickness, lineType=cv2.LINE_AA
        )

    # –ù–∞–∫–ª–∞–¥—ã–≤–∞–µ–º —Å–µ—Ç–∫—É —Å –µ–µ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å—é
    grid_alpha = grid_color[3] / 255.0
    cv2.addWeighted(grid_layer, grid_alpha, base_image, 1 - grid_alpha, 0, base_image)

    # –ù–∞–∫–ª–∞–¥—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç —Å –µ–≥–æ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å—é
    text_alpha = text_color[3] / 255.0
    cv2.addWeighted(text_layer, text_alpha, base_image, 1 - text_alpha, 0, base_image)


def get_user_map_image(user):
    start_time = time.perf_counter()
    if user.current_map is not None:
        map_ = maps[user.current_map]
    else:
        raise Exception(f'–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user.name}, —Ç–∞–∫ –∫–∞–∫ user.current_map == None')

    # –ó–∞–¥–∞—ë–º —Ä–∞–∑–º–µ—Ä –∫–∞—Ä—Ç—ã
    resolution = 1024
    cells_num = (user.controlled_ship.view_range * 2) + 1  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª–µ—Ç–æ–∫ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–µ –∫–∞—Ä—Ç—ã

    # –°–æ–∑–¥–∞–µ–º —Ñ–æ–Ω
    base_image = create_background(resolution, resolution)

    # –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≤–∏–¥–∏–º—ã–µ –∏–≥—Ä–æ–∫—É –æ–±—ä–µ–∫—Ç—ã –Ω–∞ –∫–∞—Ä—Ç–µ
    render_visible_objects(base_image, map_, user.controlled_ship)

    # –î–æ–±–∞–≤–ª—è–µ–º —Å–µ—Ç–∫—É
    add_grid(base_image, cells_num)

    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    _, buffer = cv2.imencode('.png', base_image)
    image_bytes = buffer.tobytes()

    print(f'–í—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –∫–∞—Ä—Ç—ã: {(time.perf_counter() - start_time) * 1000:.1f} –º—Å')
    return types.BufferedInputFile(image_bytes, filename="map.png")


async def update_map_message_of_user(user, dont_update_map_image = False, iteration_num = 0):
    """
    –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–∞—Ä—Ç—ã –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    :param user: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–æ—Ç–æ—Ä–æ–º—É –æ–±–Ω–æ–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–∞—Ä—Ç–æ–π
    :param dont_update_map_image: –ü—Ä–∏ True –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã(–ø–æ–ª–µ–∑–Ω–æ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫–∏ –∏–ª–∏ —Ç–µ–∫—Å—Ç)
    :param iteration_num: –ù–æ–º–µ—Ä –ø–æ–ø—ã—Ç–∫–∏, –Ω—É–∂–µ–Ω –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ —Ü–∏–∫–ª–∞
    """
    if iteration_num > 5:
        return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–¥–∞–Ω—ã –ª–∏ —É —é–∑–µ—Ä–∞ –∫–æ—Ä–∞–±–ª—å –∏ –∫–∞—Ä—Ç–∞
    if user.controlled_ship is None:
        print(f"–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –∫–∞—Ä—Ç—É –∏–≥—Ä–æ–∫—É {user.name}, —Ç–∞–∫ –∫–∞–∫ —É –Ω–µ–≥–æ –Ω–µ –∑–∞–¥–∞–Ω controlled_ship")
        return
    if user.current_map is None:
        print(f"–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –∫–∞—Ä—Ç—É –∏–≥—Ä–æ–∫—É {user.name}, —Ç–∞–∫ –∫–∞–∫ —É –Ω–µ–≥–æ –Ω–µ –∑–∞–¥–∞–Ω current_map")
        return

    if not dont_update_map_image:
        map_image = get_user_map_image(user)
    else:
        map_image = None

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —É –∏–≥—Ä–æ–∫–∞ –æ–∂–∏–¥–∞–µ–º—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –∏ –µ—Å–ª–∏ –¥–∞ —Ç–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–º–µ–Ω—ã
    if not maps[user.current_map].check_if_object_has_delayed_actions(user.controlled_ship):
        new_reply_markup=inline_keyboard_buttons.ship_control_buttons
    else:
        new_reply_markup=inline_keyboard_buttons.cancel_button

    result, new_message_id = await async_messages_operator.try_strong_edit_message_media(chat_id=user.id, message_id=user.map_message_id, new_photo=map_image, new_caption="–≠—Ç–æ –∫–∞—Ä—Ç–∞", new_reply_markup=new_reply_markup)
    if result:
        if user.map_message_id != new_message_id:
            asyncio.create_task(try_delete_message(user.id, user.map_message_id))
            user.map_message_id = new_message_id
    else:
        await try_delete_message(user.id, new_message_id)
        user.map_message_id = None
        asyncio.create_task(update_map_message_of_user(user, iteration_num=iteration_num + 1))
        print(f"–ù–µ—É–¥–∞—á–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∫–∞—Ä—Ç–æ–π, –≥–µ–Ω–µ—Ä–∏—Ä—É—é –∏ –≤—ã—Å—ã–ª–∞—é –∑–∞–Ω–æ–≤–æ({iteration_num})...")




------------------------------------------------------------
variables\bot.py:
from aiogram import Dispatcher, Bot
from settings.global_settings import token

#–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–æ—Ç–∞ –∏ –¥–∏—Å–ø–µ—Ç—á–µ—Ä
bot = Bot(token=token, timeout=3)
dp = Dispatcher()



------------------------------------------------------------
variables\event_manager.py:
from models.event import Event

from core.text_reactions.start_reaction import command_start
from core.text_reactions.map_reaction import map_button_reaction

from core.call_reactions.arrows_reaction import arrows_reaction
from core.call_reactions.cancel_reaction import cancel_reaction

text_event = Event()
call_event = Event()

text_event.add_handler(command_start)
text_event.add_handler(map_button_reaction)

call_event.add_handler(arrows_reaction)
call_event.add_handler(cancel_reaction)
